<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>ITO Online - HTML + Firebase</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#10b981}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:linear-gradient(180deg,#071426 0%, #081426 100%);color:#e6eef6;padding:18px}
    .wrap{max-width:980px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{font-size:20px;margin:0}
    .card{background:rgba(255,255,255,0.03);padding:14px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.04)}
    input,select,textarea,button{font:inherit}
    input,select,textarea{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);color:inherit;padding:8px;border-radius:8px;width:100%}
    button{background:var(--accent);color:#042024;border:none;padding:8px 10px;border-radius:10px;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;gap:12px}
    .cols-3{grid-template-columns:1fr 320px}
    .players-list{display:flex;flex-direction:column;gap:8px}
    .player{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;background:rgba(255,255,255,0.02)}
    .small{font-size:13px}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#cfe7f2}
    .linkbox{display:flex;gap:8px;align-items:center}
    .hint-input{display:flex;gap:8px}
    .order-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02))}
    @media(max-width:840px){.cols-3{grid-template-columns:1fr} header{flex-direction:column;gap:10px} }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ITO Online — versão HTML</h1>
    <div class="muted">Compartilhe a sala na sua live • Repo: GitHub Pages</div>
  </header>

  <!-- SETUP -->
  <div id="setup" class="card">
    <div class="grid" style="grid-template-columns:1fr 260px;gap:10px">
      <div>
        <label class="small muted">Nome</label>
        <input id="name" placeholder="Seu nome (ex: Patrick)" />
      </div>
      <div>
        <label class="small muted">Código da Sala</label>
        <input id="roomInput" placeholder="ex: 8Q2K (ou deixe vazio pra criar)" />
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="btnCreate">Criar Sala (host)</button>
      <button id="btnJoin" class="btn-ghost">Entrar na Sala</button>
      <button id="btnCopyLink" class="btn-ghost" style="margin-left:auto">Copiar link</button>
    </div>

    <div class="muted small" style="margin-top:12px">
      Dica: quando criar a sala, compartilhe a URL (o código fica no hash #CODIGO). Players só precisam desse link e do nome.
    </div>
  </div>

  <!-- GAME -->
  <div id="gameUI" style="display:none">
    <div class="card cols-3 grid">
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small muted">Sala</div>
            <div id="roomId" style="font-weight:700;font-size:18px">—</div>
            <div class="muted small" id="roundInfo">Rodada 1</div>
          </div>
          <div style="text-align:right">
            <div class="muted small">Você:</div>
            <div id="meName" style="font-weight:600">—</div>
            <div id="meRole" class="muted small">—</div>
          </div>
        </div>

        <hr style="border:none;height:8px" />

        <div>
          <div class="small muted">Jogadores</div>
          <div id="players" class="players-list" style="margin-top:8px"></div>
        </div>

        <hr style="border:none;height:8px" />

        <div id="phasePanel"></div>
      </div>

      <div style="display:flex;flex-direction:column;gap:8px">
        <div class="card">
          <div class="small muted">Tema</div>
          <input id="themeInput" placeholder="Ex: Ardência de pimentas" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="minRange" style="width:80px" type="number" placeholder="Min" value="1" />
            <input id="maxRange" style="width:80px" type="number" placeholder="Max" value="100" />
          </div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="btnDeal">Distribuir números (host)</button>
            <button id="btnOrdering" class="btn-ghost">Ir pra ordenação</button>
          </div>
        </div>

        <div class="card">
          <div class="small muted">Ações rápidas</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btnReveal" class="btn-ghost">Revelar</button>
            <button id="btnNextRound" class="btn-ghost">Próxima rodada</button>
          </div>
          <div class="muted small" style="margin-top:8px">Host controla Deal / Ordenação / Revelar.</div>
        </div>

        <div class="card">
          <div class="small muted">Link da sala</div>
          <div class="linkbox" style="margin-top:8px">
            <input id="roomLink" readonly style="background:transparent;border:none;color:#9fe9d0" />
            <button id="btnCopyLink2" class="btn-ghost">Copiar</button>
          </div>
        </div>
      </div>
    </div>

    <div id="orderRevealArea" style="margin-top:12px"></div>
  </div>
</div>

<!-- Firebase v9 via CDN (modular) -->
<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyAbCzvApuufT2nXKh6f_h90u2P7WOsUP74",
    authDomain: "ito-online-620e6.firebaseapp.com",
    databaseURL: "https://ito-online-620e6-default-rtdb.firebaseio.com/",
    projectId: "ito-online-620e6",
    storageBucket: "ito-online-620e6.firebasestorage.app",
    messagingSenderId: "275100669541",
    appId: "1:275100669541:web:366051288a8c209c0a988c",
    measurementId: "G-5LHBN77142"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getDatabase, ref, set, update, onValue, push, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const uid = Math.random().toString(36).slice(2,9);
  let isHost = false;
  let currentRoom = null;
  let myName = "";
  let localRoomSnapshot = null;

  const el = id => document.getElementById(id);
  const btnCreate = el('btnCreate');
  const btnJoin = el('btnJoin');
  const btnCopyLink = el('btnCopyLink');
  const btnCopyLink2 = el('btnCopyLink2');
  const btnDeal = el('btnDeal');
  const btnOrdering = el('btnOrdering');
  const btnReveal = el('btnReveal');
  const btnNextRound = el('btnNextRound');

  btnCreate.addEventListener('click', ()=>joinRoom(true));
  btnJoin.addEventListener('click', ()=>joinRoom(false));
  btnCopyLink.addEventListener('click', copyLink);
  btnCopyLink2.addEventListener('click', copyLink);
  btnDeal.addEventListener('click', startDeal);
  btnOrdering.addEventListener('click', goOrdering);
  btnReveal.addEventListener('click', revealNumbers);
  btnNextRound.addEventListener('click', nextRound);

  // Preenche campo de sala pelo hash da URL
  window.addEventListener('load', ()=> {
    const hash = location.hash.replace('#','');
    if(hash) el('roomInput').value = hash;
  });

  function joinRoom(asHost=false){
    myName = el('name').value.trim() || ('Player-'+uid);
    let roomId = el('roomInput').value.trim().toUpperCase();
    if(!roomId && asHost) roomId = Math.random().toString(36).slice(2,6).toUpperCase();
    if(!roomId){ alert('Coloque um código de sala ou crie uma.'); return; }

    currentRoom = roomId;
    isHost = Boolean(asHost);

    const playerData = { id: uid, name: myName, host: isHost, number: null, hint:'', ready:false, joinedAt: Date.now() };

    if(isHost){
      set(ref(db, `rooms/${currentRoom}`), {
        createdAt: Date.now(),
        hostId: uid,
        theme: el('themeInput').value || '',
        range: { min: Number(el('minRange').value||1), max: Number(el('maxRange').value||100) },
        phase: 'lobby',
        round: 1,
        players: { [uid]: playerData },
        order: []
      }).catch(console.error);
    } else {
      update(ref(db, `rooms/${currentRoom}/players/${uid}`), playerData).catch(console.error);
    }

    el('setup').style.display='none';
    el('gameUI').style.display='block';
    el('meName').textContent = myName;
    el('meRole').textContent = isHost?'Anfitrião':'Jogador';
    el('roomId').textContent = currentRoom;
    el('roomLink').value = location.origin + location.pathname + '#' + currentRoom;
    location.hash = currentRoom;

    listenRoom();
  }

  function copyLink(){
    const text = el('roomLink').value || (location.origin+location.pathname+'#'+el('roomInput').value.trim());
    navigator.clipboard?.writeText(text);
    alert('Link copiado!');
  }

  function listenRoom(){
    const refRoom = ref(db, `rooms/${currentRoom}`);
    onValue(refRoom, snap => { localRoomSnapshot = snap.val() || {}; renderRoom(localRoomSnapshot); });
    onValue(ref(db, `rooms/${currentRoom}/players`), snap => { renderPlayers(snap.val() || {}); });
  }

  function renderPlayers(playersObj){
    const list = el('players'); list.innerHTML='';
    Object.values(playersObj).sort((a,b)=> (a.joinedAt||0)-(b.joinedAt||0)).forEach(p=>{
      const hostLabel = p.host?' (Host)':'';
      const div=document.createElement('div'); div.className='player';
      div.innerHTML=`<div><strong>${escapeHtml(p.name)}</strong>${hostLabel}<div class="muted small">${p.hint?'Dica: '+escapeHtml(p.hint):''}</div></div><div class="small">${p.ready?'✅':''}</div>`;
      list.appendChild(div);
    });
  }

  function renderRoom(room){
    if(!room) return;
    el('roundInfo').textContent=`Rodada ${room.round||1} • Fase: ${room.phase||'—'}`;
    if(room.theme!==undefined) el('themeInput').value = room.theme||'';
    if(room.range){ el('minRange').value=room.range.min; el('maxRange').value=room.range.max; }

    const panel=el('phasePanel'); panel.innerHTML=''; const phase=room.phase||'lobby';
    if(phase==='lobby'){
      panel.innerHTML=`<div class="small muted">Ainda em lobby. Aguarde jogadores.</div>
        <div style="margin-top:8px"><button id="btnSetTheme" class="btn-ghost">Salvar tema</button></div>`;
      panel.querySelector('#btnSetTheme').addEventListener('click', ()=>{
        update(ref(db, `rooms/${currentRoom}`), { theme: el('themeInput').value || ''});
        alert('Tema atualizado.');
      });
    }

    if(phase==='dealt'){
      const me=(room.players&&room.players[uid])||null;
      if(me){
        panel.innerHTML=`<div class="small muted">Seu número secreto</div>
          <div style="font-weight:700;font-size:24px;margin-top:6px">${me.number??'—'}</div>
          <div style="margin-top:8px" class="hint-input">
            <input id="hintTxt" placeholder="Sua dica (sem falar o número)" />
            <button id="btnSendHint" class="btn-ghost">Enviar dica</button>
          </div>`;
        if(me.hint) el('hintTxt').value=me.hint;
        panel.querySelector('#btnSendHint').addEventListener('click', ()=>{
          const hint=el('hintTxt').value.trim();
          update(ref(db, `rooms/${currentRoom}/players/${uid}`), { hint, ready:true });
        });
      } else panel.innerHTML='<div class="small muted">Espere o host distribuir as cartas.</div>';
    }

    if(phase==='ordering'){ panel.innerHTML='<div class="small muted">Ordenando: host move os itens. Jogadores veem as dicas.</div>'; }
    if(phase==='reveal'){ panel.innerHTML='<div class="small muted">Números revelados — confira o resultado abaixo.</div>'; }
  }

  function startDeal(){
    if(!isHost){ alert('Somente o host pode distribuir.'); return; }
    const room=localRoomSnapshot||{};
    const players=Object.values(room.players||{});
    if(players.length<2){ alert('Precisa de pelo menos 2 jogadores.'); return; }
    const min=Number(el('minRange').value||1), max=Number(el('maxRange').value||100);
    if(max-min+1<players.length){ alert('Intervalo pequeno demais para jogadores.'); return; }

    const numbers=uniqueRandoms(players.length,min,max);
    const updates={};
    players.forEach((p,i)=>{ updates[p.id]={...p,number:numbers[i],hint:'',ready:false}; });

    update(ref(db, `rooms/${currentRoom}`), { phase:'dealt', order:players.map(p=>p.id), theme: el('themeInput').value||room.theme||'', range:{min,max} })
    .then(()=>{ for(const id in updates) update(ref(db, `rooms/${currentRoom}/players/${id}`), updates[id]); });
  }

  function goOrdering(){ if(!isHost){ alert('Somente host'); return; } update(ref(db, `rooms/${currentRoom}`), { phase:'ordering' }); }
  function revealNumbers(){ if(!isHost){ alert('Somente host'); return; } update(ref(db, `rooms/${currentRoom}`), { phase:'reveal' }); }

  function nextRound(){
    if(!isHost){ alert('Somente host'); return; }
    runTransaction(ref(db, `rooms/${currentRoom}`), cur=>{
      if(!cur) return cur;
      cur.phase='lobby';
      cur.round=(cur.round||1)+1;
      cur.order=[];
      cur.theme=el('themeInput').value||cur.theme||'';
      cur.range={min:Number(el('minRange').value||1), max:Number(el('maxRange').value||100)};
      if(cur.players) Object.keys(cur.players).forEach(k=>{ cur.players[k].number=null; cur.players[k].hint=''; cur.players[k].ready=false; });
      return cur;
    });
  }

  function uniqueRandoms(n,min,max){ const arr=[]; for(let i=min;i<=max;i++) arr.push(i); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr.slice(0,n); }
  function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
</script>
</body>
</html>
